<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>WebGL + FFmpeg @120fps</title>
  <style>
    body {
      font-family: system-ui, sans-serif;
      max-width: 760px;
      margin: 32px auto;
      padding: 0 16px;
      background: #181818;
      color: #eee;
    }
    h1 { font-weight: 500; margin-bottom: 1rem; }
    form { margin-bottom: 1.5rem; }
    input[type="file"] {
      padding: 6px;
      margin-bottom: 10px;
      display: block;
    }
    button {
      background: #28a745;
      color: #fff;
      border: none;
      padding: 8px 14px;
      cursor: pointer;
      border-radius: 4px;
      font-size: 14px;
    }
    button:disabled {
      background: #555;
      cursor: not-allowed;
    }
    progress {
      width: 100%;
      height: 16px;
      margin: 0.5rem 0 1rem;
    }
    pre {
      background: #000;
      color: #0f0;
      padding: 10px;
      max-height: 260px;
      overflow-y: auto;
      font-size: 13px;
      border-radius: 4px;
    }
    a.download {
      display: inline-block;
      margin-top: 10px;
      padding: 8px 14px;
      background: #007bff;
      color: white;
      text-decoration: none;
      border-radius: 4px;
    }
  </style>
</head>
<body>
  <h1>Upload → FFmpeg → WebGL → FFmpeg</h1>

  <form id="uploadForm" enctype="multipart/form-data">
    <input type="file" name="video" accept="video/*" required>
    <button type="submit">Process Video</button>
  </form>

  <progress id="bar" value="0" max="100"></progress>
  <pre id="log"></pre>
  <div id="output"></div>

  <script>
    const logEl = document.getElementById('log');
    const bar = document.getElementById('bar');
    const output = document.getElementById('output');

    document.getElementById('uploadForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      bar.value = 0;
      logEl.textContent = '';
      output.innerHTML = '';

      const fd = new FormData(e.target);
      const up = await fetch('/upload', { method:'POST', body: fd }).then(r => r.json());
      if (!up.ok) {
        logEl.textContent = 'Upload failed';
        return;
      }

      const run = await fetch('/run', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ filename: up.filename })
      }).then(r => r.json());

      if (!run.ok) {
        logEl.textContent = 'Job start failed';
        return;
      }

      const es = new EventSource('/logs/' + run.job);
      es.onmessage = ev => {
        const msg = JSON.parse(ev.data);

        if (msg.progress != null) {
          bar.value = msg.progress;
        }
        if (msg.log) {
          logEl.textContent += msg.log;
          logEl.scrollTop = logEl.scrollHeight;
        }
        if (msg.done) {
          es.close();
          output.innerHTML = `<a class="download" href="${msg.url}" download>Download Processed Video</a>`;
        }
        if (msg.error) {
          es.close();
          output.textContent = 'Error during processing.';
        }
      };
    });
  </script>
</body>
</html>
